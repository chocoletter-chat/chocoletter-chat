name: DEV CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Docker build ê°€ëŠ¥í•˜ë„ë¡ í™˜ê²½ ì„¤ì •
        uses: docker/setup-buildx-action@v2

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          MONGODB_URI: ${{ secrets.SPRING_DATA_MONGODB_URI }}
          KAFKA_SERVERS: ${{ secrets.SPRING_KAFKA_BOOTSTRAP_SERVERS }}
          TOPIC: ${{ secrets.TOPIC_NAME }}
          GROUP_ID: ${{ secrets.CONSUMER_GROUP_ID }}
          BROKER_ID: ${{ secrets.KAFKA_BROKER_ID }}
          LISTENERS: ${{ secrets.KAFKA_LISTENERS }}
          ADV_LISTENERS: ${{ secrets.KAFKA_ADVERTISED_LISTENERS }}
          ZOOKEEPER: ${{ secrets.KAFKA_ZOOKEEPER_CONNECT }}
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "bash -s" << 'EOL'
          set -e
          
          echo "ðŸš€ ë°°í¬ ì‹œìž‘"
          
          cd /home/ubuntu || exit 1
          
          if [ -d "/home/ubuntu/chocoletter-chat" ]; then
            echo "ðŸ“¦ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°œê²¬ - ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
            cd /home/ubuntu/chocoletter-chat
            git reset --hard origin/main
            git pull origin main
          else
            echo "ðŸ“¦ í”„ë¡œì íŠ¸ê°€ ì—†ì–´ì„œ ìƒˆë¡œ í´ë¡ "
            git clone https://github.com/chocoletter-chat/chocoletter-chat.git
            cd chocoletter-chat
          fi
          EOL
          
          # env íŒŒì¼ ìƒì„±ì„ ë³„ë„ì˜ SSH ëª…ë ¹ìœ¼ë¡œ ì‹¤í–‰
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "cat > /home/ubuntu/chocoletter-chat/.env" << 'EOL'
  SPRING_DATA_MONGODB_URI='${MONGODB_URI}'
  SPRING_KAFKA_BOOTSTRAP_SERVERS='${KAFKA_SERVERS}'
  TOPIC_NAME='${TOPIC}'
  CONSUMER_GROUP_ID='${GROUP_ID}'
  KAFKA_BROKER_ID='${BROKER_ID}'
  KAFKA_LISTENERS='${LISTENERS}'
  KAFKA_ADVERTISED_LISTENERS='${ADV_LISTENERS}'
  KAFKA_ZOOKEEPER_CONNECT='${ZOOKEEPER}'
  EOL
  
  # Docker Compose ì‹¤í–‰ì„ ìœ„í•œ ë§ˆì§€ë§‰ SSH ëª…ë ¹
  ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "bash -s" << 'EOL'
  cd /home/ubuntu/chocoletter-chat/chat
  
  echo "ðŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
  sudo docker-compose down
  
  echo "ðŸ”„ ìµœì‹  ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹¤í–‰"
  sudo docker-compose up -d spring-boot-app
  
  echo "âœ… ë°°í¬ ì™„ë£Œ!"
  EOL