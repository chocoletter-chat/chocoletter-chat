name: DEV CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Docker build ê°€ëŠ¥í•˜ë„ë¡ í™˜ê²½ ì„¤ì •
        uses: docker/setup-buildx-action@v2

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash -s' << 'EOF'
            set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
          
            echo "ðŸš€ ë°°í¬ ì‹œìž‘"
          
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì´ë™ ë˜ëŠ” í´ë¡ 
            cd /home/ubuntu || exit 1
          
            if [ -d "/home/ubuntu/chocoletter-chat" ]; then
              echo "ðŸ“¦ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°œê²¬ - ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
              cd /home/ubuntu/chocoletter-chat
              git reset --hard origin/main  # ë³€ê²½ëœ íŒŒì¼ ì´ˆê¸°í™”
              git pull origin main
            else
              echo "ðŸ“¦ í”„ë¡œì íŠ¸ê°€ ì—†ì–´ì„œ ìƒˆë¡œ í´ë¡ "
              git clone https://github.com/chocoletter-chat/chocoletter-chat.git
              cd chocoletter-chat
            fi
          
            # `.env` íŒŒì¼ ìƒì„±
            cat > .env <<EOL
            SPRING_DATA_MONGODB_URI=${{ secrets.SPRING_DATA_MONGODB_URI }}
            SPRING_KAFKA_BOOTSTRAP_SERVERS=${{ secrets.SPRING_KAFKA_BOOTSTRAP_SERVERS }}
            TOPIC_NAME=${{ secrets.TOPIC_NAME }}
            CONSUMER_GROUP_ID=${{ secrets.CONSUMER_GROUP_ID }}
            KAFKA_BROKER_ID=${{ secrets.KAFKA_BROKER_ID }}
            KAFKA_LISTENERS=${{ secrets.KAFKA_LISTENERS }}
            KAFKA_ADVERTISED_LISTENERS=${{ secrets.KAFKA_ADVERTISED_LISTENERS }}
            KAFKA_ZOOKEEPER_CONNECT=${{ secrets.KAFKA_ZOOKEEPER_CONNECT }}
            EOL
  
            echo "âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ!"
          
            # Docker Compose ì‹¤í–‰
            cd ./chat
          
            echo "ðŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
            sudo docker-compose down
          
            echo "ðŸ”„ ìµœì‹  ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹¤í–‰"
            sudo docker-compose up -d spring-boot-app
          
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          EOF
