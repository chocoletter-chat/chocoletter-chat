name: Deploy to EC2

on:
  push:
    branches:
      - main # main ë¸Œëžœì¹˜ë¡œ í‘¸ì‹œí•  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash -s' << 'EOF'
          set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

          echo "ðŸš€ ë°°í¬ ì‹œìž‘"

          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë˜ëŠ” í´ë¡ 
          cd /home/ubuntu || exit 1

          if [ -d "/home/ubuntu/chocoletter-chat" ]; then
            echo "ðŸ“¦ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°œê²¬ - ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
            cd /home/ubuntu/chocoletter-chat
            git reset --hard origin/main  # ë³€ê²½ëœ íŒŒì¼ ì´ˆê¸°í™”
            git pull origin main
          else
            echo "ðŸ“¦ í”„ë¡œì íŠ¸ê°€ ì—†ì–´ì„œ ìƒˆë¡œ í´ë¡ "
            git clone https://github.com/chocoletter-chat/chocoletter-chat.git
            cd chocoletter-chat
          fi

          # Docker Compose ì‹¤í–‰
          cd ./chat

          echo "ðŸ”„ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸ ë° ìž¬ì‹œìž‘"
          sudo docker-compose up -d spring-boot-app

          echo "âœ… ë°°í¬ ì™„ë£Œ!"
        EOF
